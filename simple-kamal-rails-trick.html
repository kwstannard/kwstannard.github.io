<head><link href="style/post.css" rel="stylesheet" /><script src="script/post.js"></script></head><body onload="checkfun()"><aside><h4><a href="index.html">Main Page</a></h4><h4>Options</h4><table><tr><td><label for="fun">Tilt</label></td><td><input checked="true" id="fun" onclick="checkfun()" pattern="true" type="checkbox" /></td></tr></table></aside><main><h1 id="kamal-rails-and-ruby-version">Kamal, Rails, and Ruby version</h1>

<p>Today I have an undocumented trick for those building images with Kamal for
those of you who are, like me, bothered that the ruby version is duplicated in
the Dockerfile and .ruby-version.</p>

<h2 id="dockerfile">Dockerfile</h2>

<p>The default Dockerfile contains the directive:</p>

<pre><code>ARG RUBY_VERSION=4.0.1
FROM docker.io/library/ruby:$RUBY_VERSION-slim AS base
</code></pre>

<p>This allows injection of the Ruby version by setting a docker build-arg option.
If you were to run <code>docker build</code> and set <code>--build-arg RUBY_VERSION</code> without a
value, docker will get the value from the environment.</p>

<h2 id="ruby">Ruby</h2>

<p>When you run Ruby, it sets RUBY_VERSION in it’s environment. Any commands run
from within Ruby will get this enviroment variable. Kamal is a Ruby executable,
so it will have the correct RUBY_VERSION for your application.</p>

<h2 id="deployyml">deploy.yml</h2>

<p>Kamal allow you to set build args in deploy.yml. It even already has a
commented out <code>RUBY_VERSION: 4.0.1</code>.</p>

<h2 id="connecting-the-dots">Connecting the dots</h2>

<p>Just uncommenting the line is not enough. Kamal expects the build args to be a
hash, which conflicts with trying to get Kamal to run with <code>--build-arg
RUBY_VERSION</code> at first glance. The trick here is a (seemingly) undocumented
feature of Kamal::Utils.argumentize. Any value that gives false to
<code>VALUE.present?</code> will result in <code>--OPTION KEY</code>, while “present” values result
in <code>--OPTION KEY=VALUE</code>.</p>

<p>This means that any of the following will result in passing of RUBY_VERSION
from the Kamal process to the docker build and save you a duplicated config:</p>

<pre><code>RUBY_VERSION: ""
RUBY_VERSION: null
RUBY_VERSION: []
RUBY_VERSION: {}
</code></pre>
</main></body>